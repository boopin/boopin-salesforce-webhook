
{% extends "base.html" %}
{% block content %}

{% if failed_count > 5 %}
<div class="alert alert-danger text-center fw-bold">
  ⚠️ Warning: High number of failed leads ({{ failed_count }}) detected!
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <label for="threshold" class="form-label me-2 fw-bold">⚙️ Alert Threshold:</label>
    <select id="threshold" class="form-select d-inline-block w-auto">
      <option value="3">3</option>
      <option value="5" selected>5</option>
      <option value="10">10</option>
      <option value="15">15</option>
    </select>
  </div>
  <div>
    <span class="me-2">Auto-Refresh Stats</span>
    <input type="checkbox" checked class="form-check-input">
  </div>
</div>

<div id="alertBox" class="alert alert-danger text-center fw-bold d-none">
  ⚠️ Warning: High number of failed leads detected!
</div>

<div class="row text-center mb-4">
  <div class="col-md-4">
    <div class="bg-white shadow-sm rounded p-3 border border-primary">
      <h5 class="text-primary">📈 Total Leads Submitted</h5>
      <h2 class="text-primary" id="lead-count">{{ lead_count }}</h2>
    </div>
  </div>
  <div class="col-md-4">
    <div class="bg-white shadow-sm rounded p-3 border border-secondary">
      <h5 class="text-muted">🕒 Last Submission</h5>
      <h2 class="text-muted" id="last-submission">{{ last_time or '-' }}</h2>
    </div>
  </div>
  <div class="col-md-4">
    <div class="bg-white shadow-sm rounded p-3 border border-danger">
      <h5 class="text-danger">❌ Failed Leads</h5>
      <h2 class="text-danger" id="failed-count">{{ failed_count }}</h2>
    </div>
  </div>
</div>

<div class="d-grid gap-2 col-lg-6 mx-auto">
  <a href="/form" class="btn btn-primary btn-lg">📩 Submit Test Lead</a>
  <a href="/logs" class="btn btn-outline-secondary">📄 View Lead Logs</a>
  <a href="/failed-logs" class="btn btn-outline-danger">🚫 View Failed Logs</a>
  <a href="/dashboard" class="btn btn-outline-info">📊 View Dashboard</a>
  <a href="/download-log" class="btn btn-outline-dark">⬇️ Download CSV</a>
  <a href="/export-excel" class="btn btn-success">📥 Export to Excel</a>
</div>

<script>
  function checkThreshold(failedCount, threshold) {
    const alertBox = document.getElementById("alertBox");
    if (failedCount >= threshold) {
      alertBox.classList.remove("d-none");
    } else {
      alertBox.classList.add("d-none");
    }
  }

  function refreshStats() {
    fetch('/api/stats')
      .then(res => res.json())
      .then(data => {
        document.getElementById("lead-count").textContent = data.lead_count;
        document.getElementById("last-submission").textContent = data.last_time || '-';
        const failed = parseInt(document.getElementById("failed-count").textContent);
        const threshold = parseInt(document.getElementById("threshold").value);
        checkThreshold(failed, threshold);
      });
  }

  document.getElementById("threshold").addEventListener("change", () => {
    const failed = parseInt(document.getElementById("failed-count").textContent);
    const threshold = parseInt(document.getElementById("threshold").value);
    checkThreshold(failed, threshold);
  });

  setInterval(refreshStats, 30000);
</script>

{% endblock %}
